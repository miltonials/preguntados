@model IEnumerable<preguntados.Models.Historial>

@{
    ViewData["Title"] = "Index";
}


<div class="container">
    <div class="row">
        <h1>Bienvenido @ViewBag.player | sesion: @ViewBag.idSesion</h1>
        <div class="col-md-6">
            <div class="align-content-center">

        
            <button id="startButton" class="btn btn-primary">Iniciar partida</button>
            <div id="questionContainer">
            </div>

            @section Scripts {
                <script>
                    let correctAnswersCount = 0;
                    let correctAnswer = "";
                    let sesion = @Html.Raw(Json.Serialize(ViewBag.idSesion));

                    document.getElementById("startButton").addEventListener("click", async function () {
                        document.getElementById("startButton").style.display = "none";
                        showQuestion(0);
                        await fetch(`/Preguntas/ValidarRespuesta?idPregunta=${0}&respuesta=Z&sesion=${sesion}`, {
                            method: 'POST',
                            headers: {
                                'Accept': 'application/json'
                            }
                        });
                    });

                    function showQuestion(index) {
                        let questions = @Html.Raw(Json.Serialize(ViewBag.preguntas));
                        let question = questions[index];

                        if (!question) {
                            //let response = await fetch(`/Preguntas/ValidarRespuesta?idPregunta=${question.id}&respuesta=${selectedAnswer}&sesion=${sesion}`, {
                            //        method: 'POST',
                            //        headers: {
                            //            'Accept': 'application/json'
                            //        }
                            //    });

                            document.getElementById("questionContainer").innerHTML = `
                                <h3>Fin del juego</h3>
                                <p>Respuestas correctas: ${correctAnswersCount}</p>
                            `;
                        } else {
                            correctAnswer = question.respuestaCorrecta;
                            document.getElementById("questionContainer").innerHTML = `
                                <h3>Pregunta:</h3>
                                <p>${question.pregunta}</p>
                                <form id="answerForm">
                                    <input type="radio" name="answer" value="A" /> ${question.opcionA} <br />
                                    <input type="radio" name="answer" value="B" /> ${question.opcionB} <br />
                                    <input type="radio" name="answer" value="C" /> ${question.opcionC} <br />
                                    <input type="submit" value="Responder" class="btn btn-primary" />
                                </form>
                            `;

                            document.getElementById("answerForm").addEventListener("submit", async function (event) {
                                event.preventDefault();

                                let selectedAnswer = document.querySelector('input[name="answer"]:checked').value;

                                // Llamada a la API para validar la respuesta en el servidor
                                await fetch(`/Preguntas/ValidarRespuesta?idPregunta=${question.id}&respuesta=${selectedAnswer}&sesion=${sesion}`, {
                                    method: 'POST',
                                    headers: {
                                        'Accept': 'application/json'
                                    }
                                });

                                showQuestion(index + 1);
                            });
                        }
                    }
                </script>
            }
            
        </div>
        </div>
        <div class="col-md-6 border">
            <h3>Historial de partidas</h3>
            @*<iframe src="~/../historial" width="100%" height="500px"></iframe>*@
            <table class="table">
                <thead>
                    <tr>
                        <th>
                            @Html.DisplayNameFor(model => model.Jugador)
                        </th>
                        <th>
                            @Html.DisplayNameFor(model => model.Aciertos)
                        </th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td>
                                @Html.DisplayFor(modelItem => item.Id)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.Aciertos)
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>